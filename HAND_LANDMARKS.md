# 手部关键点与坐标说明（基于当前代码）

## 关键点索引
- 采用 MediaPipe HandLandmarker 标准 21 点索引：
  - `0`：腕部 `WRIST`
  - 拇指：`1` `CMC`，`2` `MCP`，`3` `IP`，`4` `TIP`
  - 食指：`5` `MCP`，`6` `PIP`，`7` `DIP`，`8` `TIP`
  - 中指：`9` `MCP`，`10` `PIP`，`11` `DIP`，`12` `TIP`
  - 无名指：`13` `MCP`，`14` `PIP`，`15` `DIP`，`16` `TIP`
  - 小指：`17` `MCP`，`18` `PIP`，`19` `DIP`，`20` `TIP`
- 代码中对手指分组的映射：
  - `THUMB`：`{ mcp: 2, ip: 3, tip: 4 }`
  - `INDEX`：`{ mcp: 5, pip: 6, dip: 7, tip: 8 }`
  - `MIDDLE`：`{ mcp: 9, pip: 10, dip: 11, tip: 12 }`
  - `RING`：`{ mcp: 13, pip: 14, dip: 15, tip: 16 }`
  - `PINKY`：`{ mcp: 17, pip: 18, dip: 19, tip: 20 }`
- 代码参考：`src/gesture.ts:3-8`

## 坐标来源与像素坐标
- MediaPipe 输出的关键点是归一化坐标（相对视频宽高的 0..1）
- 代码转换为画布像素坐标：
  - `toVec2(landmarks, w, h)` 将 `(x*w, y*h)` 转换到像素
  - 参考：`src/handsPipeline.ts:17-20`
- 主循环中以视频元素尺寸作为画布大小，保证绘制与检测一致：`src/main.ts:37-43`

## 骨架连线与描边
- 绘制的连线链：
  - 掌心轮廓与指根：`[0, 5, 9, 13, 17, 0]`
  - 食指：`[5, 6, 7, 8]`
  - 中指：`[9, 10, 11, 12]`
  - 无名指：`[13, 14, 15, 16]`
  - 小指：`[17, 18, 19, 20]`
  - 拇指：`[2, 3, 4]`
- 采样页骨架描边与点绘制加粗：
  - 参考：`src/record.ts:61-89`
- 主页面骨架绘制函数：
  - 参考：`src/main.ts:102-126`

## 坐标归一化（用于采样与通用调用）
- 归一化目的：将不同距离与大小的手势转换到统一坐标系，便于训练与调用
- 基准定义：
  - 掌心中心 `C`：对点 `{0, 5, 9, 13, 17}` 求平均得到中心
    - 参考：`src/recorder.ts:21-31`
  - 尺度 `S`：`distance(WRIST(0), MIDDLE_MCP(9))`
    - 参考：`src/recorder.ts:13-19`
- 归一化方法：
  - 对每个点 `p`，计算 `((p.x - C.x)/S, (p.y - C.y)/S)`，得到特征向量 `[x1', y1', x2', y2', ...]`
  - 参考：`src/recorder.ts:33-41`

## 镜像处理与一致性
- 为保证画面方向与交互一致，渲染阶段可选镜像：
  - 视频镜像：`translate(canvas.width, 0)` + `scale(-1, 1)` 绘制视频
    - 参考：`src/main.ts:42-51`、`src/record.ts:49-59`
  - 骨架镜像：在渲染时采用同样变换
    - 主界面：`src/main.ts:83-95`
    - 采样页：`src/record.ts:218-226`
  - 粒子渲染：与图像一致使用镜像变换
    - 参考：`src/main.ts:129-137`
- 采样图像裁剪时会考虑镜像状态以得到正确的手部局部图：`src/record.ts:146-181`

## 手势判定（简化规则）
- 食指伸展判定：`distance(MCP, TIP) > distance(MCP, PIP) * 1.2` 且相对尺度阈值
- 捏合：拇指尖与食指尖距离小于尺度阈值
- 全伸展/全收拢，单指/双指组合识别
- 参考：`src/gesture.ts:16-25, 31-60`

## 采样数据格式（通用）
- 样品包含：
  - `ts`：时间戳（毫秒）
  - `sampleHash`：`md5(JSON.stringify(features))`
  - `features`：归一化关键点数组（长度 42）
  - `image`：样品图像路径（在批次保存 JSON 中）
- 批次保存（按“手势名称”存储）：
  - 图片目录：`gestures/<name>/images/`
  - 数据目录：`gestures/<name>/data/`
  - 文件名对齐：`sample-<n>-<hash8>.png` 与 `sample-<n>-<hash8>.json`
  - MD5记录：`gestures/<name>/samples.md5`，每行 `md5  relative_path`
  - 参考：`src/recorder.ts:116-175, 191-241`

## 调用建议
- 读取 `features` 即可用于匹配与训练；镜像状态已在渲染阶段对齐
- 建议对多帧进行稳态采样，取均值特征以提升一致性

## 调用与映射
- 建议结合 `AR_MAPPING_SPEC.md` 使用，通过手势编码映射到 AR 引擎事件（平移、缩放、旋转、刷新、颜色与参数编辑等）。
- 归一化特征可直接作为训练集或在线匹配的输入；镜像一致性在渲染阶段已处理。
  "id": "034",
  "name": "倒赞",
    "id": "008",
  "name": "前八",
    "id": "010",
  "name": "前八二",
    "id": "009",
  "name": "前八一",
    "id": "015",
  "name": "前比工",
    "id": "014",
  "name": "前比六",
    "id": "016",
  "name": "前比王",
    "id": "013",
  "name": "前比心",
    "id": "011",
  "name": "前二捏",
    "id": "003",
  "name": "前二指",
    "id": "007",
  "name": "前平拳",
    "id": "001",
  "name": "前平掌",
    "id": "012",
  "name": "前三捏",
    "id": "004",
  "name": "前三指",
    "id": "005",
  "name": "前四指",
    "id": "002",
  "name": "前一指",
    "id": "006",
  "name": "前正拳",
    "id": "032",
  "name": "三叠指",
    "id": "036",
  "name": "小二指",
    "id": "035",
  "name": "小拇指",
    "id": "038",
  "name": "虚握",
    "id": "033",
  "name": "赞指",
    "id": "017",
  "name": "正错指",
    "id": "019",
  "name": "正勾二",
    "id": "020",
  "name": "正勾三",
    "id": "021",
  "name": "正勾四",
    "id": "022",
  "name": "正勾五",
    "id": "018",
  "name": "正勾指",
    "id": "029",
  "name": "正枪二",
    "id": "030",
  "name": "正枪三",
    "id": "028",
  "name": "正枪指",
    "id": "023",
  "name": "正缺二",
    "id": "026",
  "name": "正缺无",
    "id": "024",
  "name": "正缺一",
    "id": "025",
  "name": "正缺中",
    "id": "037",
  "name": "OK指",
